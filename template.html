<!DOCTYPE html>
<html>
<head>
    <title>{{@root.strings.title}}</title>

    <style>
        td a {
            text-decoration: none;
        }

        td a > span {
            font-size: 20px;
        }

        .iconmedium {
            margin-right: 6px;
        }

        #requestbutton {
            z-index: 10;
            position: fixed;
            bottom: 40px;
            right: 40px;
        }

        #toast {
            z-index: 10;
            position: fixed;
            bottom: 40px;
            left: 40px;
        }

        #requestbutton > div {
            background: rgba(255, 255, 255, .1);
            border: 1px solid #AAA;
            border-radius: 6px;
            padding: 10px 20px;
        }


    </style>

</head>
<body data-bs-theme="dark">
    <div class="container">
        <div style="float: right; margin-top: 10px">
            <button type="button" class="btn btn-primary" onclick="expandAll()">Expand All</button>
        </div>

        <h1>{{@root.strings.title}}</h1>

        {{#each chars}}
        <h4>{{name}}</h4>

        <div class="accordion">
            {{#each data}}
            {{#if items}}

            <div class="accordion-item">
                <h2 class="accordion-header">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{@../index}}-{{id}}" aria-expanded="false" aria-controls="collapse{{@../index}}-{{id}}">
                        {{category}}
                    </button>
                </h2>

                <div id="collapse{{@../index}}-{{id}}" class="accordion-collapse collapse">
                    <div class="accordion-body">
                        <table class="table table-striped align-middle">
                            <thead>
                                <tr>
                                    <th width="60%">{{@root.strings.item}}</th>
                                    <th width="20%">{{@root.strings.available}}</th>
                                    <th width="20%">{{@root.strings.request}}</th>
                                </tr>
                            </thead>

                            <tbody>
                                {{#each items}}
                                <tr>
                                    <td><a href="{{@root.strings.url}}{{id}}">{{name}}</a></td>
                                    <td>{{amount}}</td>
                                    <td><input min="0" max="{{amount}}" type="number" class="form-control" onchange="updateRequest('{{id}}', `{{name}}`, this.value)" /></td>
                                </tr>
                                {{/each}}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            {{/if}}
            {{/each}}
        </div>

        <br />
        {{/each}}
    </div>

    <div id="requestbutton">
        <script>
            const request_limit = 600000; // 10 minutes
            const last = new Date(localStorage.getItem("last_request"));
            const elapsed = new Date() - last;

            if(last.getTime() && elapsed < request_limit)
                document.write(`<div>{{@root.strings.next_request}}<br />${((request_limit - elapsed) / 1000) | 0} {{@root.strings.seconds}}</div>`);
            else
                document.write(`<button onclick="submitRequest();" class="btn btn-danger btn-lg">{{@root.strings.request}}</button>`);
        </script>
    </div>

    <div id="toast" class="toast-container">

        <div class="toast align-items-center text-bg-primary border-0" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body">placeholder</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>

    </div>

<script>const whTooltips = {colorLinks: true, iconizeLinks: true, renameLinks: true, iconSize: 'medium'};</script>
<script src="https://wow.zamimg.com/js/tooltips.js"></script>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>

<script>
    const request = {};

    function expandAll() {
        const collapses = document.getElementsByClassName('collapse');
        for(let i in collapses) {
            const c = collapses[i];
            c.className += ' show';
        }

        const buttons = document.getElementsByClassName('accordion-button');
        for(let i in buttons) {
            const c = buttons[i];
            c.className = 'accordion-button';
        }
    }

    function updateRequest(id, name, amount) {
        request[id] = {id, name, amount: amount | 0};
    }

    function toast(msg, type = "primary") {
        console.log(type, msg);
        const container = document.getElementById("toast");

        container.innerHTML = `
            <div class="toast align-items-center text-bg-${type} border-0" role="alert" aria-live="assertive" aria-atomic="true">
              <div class="d-flex">
                <div class="toast-body">${msg}</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
              </div>
            </div>`;

        const t = new bootstrap.Toast(container.getElementsByClassName('toast')[0]);
        t.show();
    }

    function submitRequest() {
        const name = window.prompt("Character Name");
        const items = Object.values(request).filter(r => r.amount);
        const last = new Date(localStorage.getItem("last_request"));

        if(!name || !items.length) return;
        if(last.getTime() && (new Date() - last) < request_limit) return;

        localStorage.setItem("last_request", new Date());
        document.getElementById("requestbutton").innerHTML = "<div>{{@root.strings.next_request}}<br />10 {{@root.strings.minutes}}</div>";

        fetch("/request", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({name, items}),
        }).then(() => {
            toast("Anfrage erfolgreich.", "success");
        }).catch(() => {
            toast("Anfrage fehlgeschlagen.", "danger");
        });
    }
</script>

</body>
</html>