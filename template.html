<!DOCTYPE html>
<html>
<head>
    <title>{{@root.strings.title}}</title>

    <style>
        td a {
            text-decoration: none;
        }

        td a > span {
            font-size: 20px;
        }

        .iconmedium {
            margin-right: 6px;
        }

        #requestbutton {
            position: fixed;
            bottom: 40px;
            right: 40px;
        }
    </style>

</head>
<body data-bs-theme="dark">
    <div class="container">
        <div style="float: right; margin-top: 10px">
            <button type="button" class="btn btn-primary" onclick="expandAll()">Expand All</button>
        </div>

        <h1>{{@root.strings.title}}</h1>

        {{#each chars}}
        <h4>{{name}}</h4>

        <div class="accordion">
            {{#each data}}
            {{#if items}}

            <div class="accordion-item">
                <h2 class="accordion-header">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{@../index}}-{{id}}" aria-expanded="false" aria-controls="collapse{{@../index}}-{{id}}">
                        {{category}}
                    </button>
                </h2>

                <div id="collapse{{@../index}}-{{id}}" class="accordion-collapse collapse">
                    <div class="accordion-body">
                        <table class="table table-striped align-middle">
                            <thead>
                                <tr>
                                    <th width="60%">{{@root.strings.item}}</th>
                                    <th width="20%">{{@root.strings.available}}</th>
                                    <th width="20%">{{@root.strings.request}}</th>
                                </tr>
                            </thead>

                            <tbody>
                                {{#each items}}
                                <tr>
                                    <td><a href="{{@root.strings.url}}{{id}}">{{name}}</a></td>
                                    <td>{{amount}}</td>
                                    <td><input min="0" max="{{amount}}" type="number" class="form-control" onchange="updateRequest('{{id}}', '{{name}}', this.value)" /></td>
                                </tr>
                                {{/each}}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            {{/if}}
            {{/each}}
        </div>

        <br />
        {{/each}}
    </div>

    <div id="requestbutton">
        <button onclick="submitRequest(this);" class="btn btn-danger btn-large">{{@root.strings.request}}</button>
    </div>

<script>const whTooltips = {colorLinks: true, iconizeLinks: true, renameLinks: true, iconSize: 'medium'};</script>
<script src="https://wow.zamimg.com/js/tooltips.js"></script>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>

<script>
    const request = {};

    function expandAll() {
        const collapses = document.getElementsByClassName('collapse');
        for(let i in collapses) {
            const c = collapses[i];
            c.className += ' show';
        }

        const buttons = document.getElementsByClassName('accordion-button');
        for(let i in buttons) {
            const c = buttons[i];
            c.className = 'accordion-button';
        }
    }

    function updateRequest(id, name, amount) {
        request[id] = {id, name, amount: amount | 0};
    }

    function submitRequest(btn) {
        const name = window.prompt("Character Name");
        const items = Object.values(request).filter(r => r.amount);
        if(!name || !items.length) return;

        btn.disabled = true;
        fetch("/request", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({name, items}),
        });
    }
</script>

</body>
</html>